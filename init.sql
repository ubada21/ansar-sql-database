DROP TABLE IF EXISTS PASSWORD_RESET_OTPS, REGISTRATION, COURSE_INSTRUCTORS, USER_ROLE, ENROLLMENTS, COURSE_SCHEDULE, USERS, ROLES, COURSES, TRANSACTIONS, DONORS;

-- USERS TABLE, UID ATM IS JUST INT THAT AUTO-INCREMENTS, CAN CHANGE LATER ACCORDING TO SPEC
CREATE TABLE USERS (
  UID INT PRIMARY KEY AUTO_INCREMENT,
  FIRSTNAME VARCHAR(100) NOT NULL,
  MIDDLENAME VARCHAR(100),
  LASTNAME VARCHAR(100) NOT NULL,
  DOB DATE,
  EMAIL VARCHAR(100) UNIQUE,
  PHONENUMBER VARCHAR(10) NOT NULL,
  ADDRESS VARCHAR(100) NOT NULL,
  CITY VARCHAR(25) NOT NULL,
  PROVINCE VARCHAR(2) NOT NULL,
  POSTALCODE VARCHAR(6) NOT NULL,
  PASSWORD VARCHAR(255) NOT NULL
);

CREATE TABLE ROLES (
  ROLEID INT PRIMARY KEY AUTO_INCREMENT,
  ROLENAME VARCHAR(25) NOT NULL
);



-- USER_ROLES JUNCTION TABLE
CREATE TABLE USER_ROLE (
  UID INT,
  ROLEID INT,
  PRIMARY KEY (UID, ROLEID),
  FOREIGN KEY (UID) REFERENCES USERS(UID) ON DELETE CASCADE,
  FOREIGN KEY (ROLEID) REFERENCES ROLES(ROLEID) ON DELETE CASCADE
);


CREATE TABLE PASSWORD_RESET_OTPS (
  ID INT PRIMARY KEY AUTO_INCREMENT,
  UID INT NOT NULL,
  OTP VARCHAR(10) NOT NULL,
  EXPIRESAT DATETIME NOT NULL,
  USED BOOLEAN DEFAULT FALSE,
  CREATEDAT DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (UID) REFERENCES USERS(UID)
);

CREATE TABLE DONORS (
  DONOR_ID INT PRIMARY KEY AUTO_INCREMENT,
  UID INT NULL,
  EMAIL VARCHAR(255) UNIQUE,
  FIRSTNAME VARCHAR(100) NOT NULL,
  LASTNAME VARCHAR(100) NOT NULL,
  AMOUNT_DONATED DECIMAL(12, 2) DEFAULT 0,
  LAST_DONATION_AT DATETIME,
  FOREIGN KEY (UID) REFERENCES USERS(UID)
);

CREATE TABLE TRANSACTIONS (
  TRANSACTION_ID INT PRIMARY KEY AUTO_INCREMENT,
  EMAIL VARCHAR(255) NOT NULL,
  DONOR_ID INT NULL,
  AMOUNT DECIMAL(12, 2) NOT NULL,
  METHOD VARCHAR(100) NOT NULL,
  TRANSACTION_DATE DATETIME DEFAULT CURRENT_TIMESTAMP,
  ADDRESS VARCHAR(100),
  CITY VARCHAR(25),
  PROVINCE VARCHAR(2),
  POSTALCODE VARCHAR(6),
  NOTES TEXT,
  RECEIPT_NUMBER VARCHAR(100) UNIQUE,
  FOREIGN KEY (DONOR_ID) REFERENCES DONORS(DONOR_ID)
);

CREATE TABLE COURSES (
  COURSEID INT PRIMARY KEY AUTO_INCREMENT,
  TITLE VARCHAR(100),
  STARTDATE DATETIME NOT NULL,
  ENDDATE DATETIME NOT NULL,
  LOCATION VARCHAR(100)
);

CREATE TABLE COURSE_SCHEDULE (
  SCHEDULEID INT PRIMARY KEY AUTO_INCREMENT,
  COURSEID INT NOT NULL,
  WEEKDAY ENUM('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday') NOT NULL,
  START_TIME TIME NOT NULL,
  END_TIME TIME NOT NULL,
  FOREIGN KEY (COURSEID) REFERENCES COURSES(COURSEID) ON DELETE CASCADE
);

CREATE TABLE COURSE_INSTRUCTORS (
  COURSEID INT NOT NULL,
  UID INT NOT NULL,
  PRIMARY KEY (COURSEID, UID),
  FOREIGN KEY (COURSEID) REFERENCES COURSES(COURSEID) ON DELETE CASCADE,
  FOREIGN KEY (UID) REFERENCES USERS(UID) ON DELETE CASCADE
);

CREATE TABLE ENROLLMENTS (
  ENROLLMENTID INT PRIMARY KEY AUTO_INCREMENT,
  UID INT NOT NULL,
  COURSEID INT NOT NULL,
  ENROLL_DATE DATETIME DEFAULT CURRENT_TIMESTAMP,
  STATUS ENUM('active', 'completed', 'withdrawn', 'failed') DEFAULT 'active',
  FINAL_GRADE DECIMAL(5,2) DEFAULT 0.0,
  FOREIGN KEY (UID) REFERENCES USERS(UID) ON DELETE CASCADE,
  FOREIGN KEY (COURSEID) REFERENCES COURSES(COURSEID) ON DELETE CASCADE,
  UNIQUE (UID, COURSEID) -- prevent duplicate enrollments
);

INSERT INTO USERS (FIRSTNAME, MIDDLENAME, LASTNAME, DOB, EMAIL, PASSWORD, PHONENUMBER, ADDRESS, CITY, PROVINCE, POSTALCODE)
VALUES 
('Ali', 'Ahmed', 'Khan', '1990-04-20', 'ali.khan@example.com', '$2a$12$t.dfg8H85VmdBrlXF2IK4uiE5PfyZYyc3hP83F4vbeCD4tWpRB1eS', '6045551234', '123 Main St', 'Vancouver', 'BC', 'V5K0A1'),
('Ubada', NULL, 'Raja', '1995-09-15', 'ubada.r@example.com','$2a$12$t.dfg8H85VmdBrlXF2IK4uiE5PfyZYyc3hP83F4vbeCD4tWpRB1eS', '6045555678', '456 Oak Ave', 'Burnaby', 'BC', 'V5C2Z4'),
('Yusuf', 'Ibrahim', 'Ali', '2000-01-05', 'yusuf.s@example.com', '$2a$12$t.dfg8H85VmdBrlXF2IK4uiE5PfyZYyc3hP83F4vbeCD4tWpRB1eS', '6045559876', '789 Pine Rd', 'Surrey', 'BC', 'V3T3W2'),
('Hamza', 'Omar', 'Siddiqui', '1997-07-18', 'hamza.s@example.com','$2a$12$t.dfg8H85VmdBrlXF2IK4uiE5PfyZYyc3hP83F4vbeCD4tWpRB1eS', '6045551122', '159 Maple St', 'Surrey', 'BC', 'V3W5N9'),
('Khalid', NULL, 'Hussein', '1992-02-25', 'khalid.h@example.com','$2a$12$t.dfg8H85VmdBrlXF2IK4uiE5PfyZYyc3hP83F4vbeCD4tWpRB1eS', '6045553344', '753 Birch Ave', 'Burnaby', 'BC', 'V5A3L7'),
('Imran', 'Yusuf', 'Malik', '1989-10-03', 'imran.m@example.com','$2a$12$t.dfg8H85VmdBrlXF2IK4uiE5PfyZYyc3hP83F4vbeCD4tWpRB1eS', '6045555566', '852 Willow Rd', 'Vancouver', 'BC', 'V5Z2M3'),
('Zaid', NULL, 'Qureshi', '2001-12-29', 'zaid.q@example.com', '$2a$12$t.dfg8H85VmdBrlXF2IK4uiE5PfyZYyc3hP83F4vbeCD4tWpRB1eS', '6045557788', '456 Aspen Dr', 'Delta', 'BC', 'V4C4X2'),
('Adnan', 'Ibrahim', 'Farooq', '1995-04-14', 'adnan.f@example.com', '$2a$12$t.dfg8H85VmdBrlXF2IK4uiE5PfyZYyc3hP83F4vbeCD4tWpRB1eS', '6045559900', '963 Oak Crescent', 'Richmond', 'BC', 'V6Y3G4');



INSERT INTO ROLES (ROLENAME) VALUES
('Admin'),
('Instructor'),
('Parent'),
('Student'),
('Donor');

INSERT INTO USER_ROLE (UID, ROLEID)
VALUES
(2, 2),
(1, 4),
(3, 4),
(5, 1),
(6, 2);

INSERT INTO COURSES (TITLE, STARTDATE, ENDDATE, LOCATION) VALUES
('Quran', '2025-09-01 18:00:00', '2025-12-15 20:00:00', 'Masjid Al-Huda - Hall A'),
('Intro to Fiqh', '2025-09-05 17:30:00', '2025-12-10 19:30:00', 'Masjid An-Nur - Room 2'),
('Seerah of the Prophet', '2025-09-03 18:00:00', '2025-12-13 19:30:00', 'Islamic Center - Main Hall'),
('Arabic for Beginners', '2025-10-01 17:00:00', '2026-01-15 19:00:00', 'Community Hall - Room B'),
('Hadith Studies', '2025-09-10 19:00:00', '2025-12-20 20:30:00', 'Online via Zoom');


INSERT INTO COURSE_SCHEDULE (COURSEID, WEEKDAY, START_TIME, END_TIME) VALUES
(1, 'Monday', '18:00:00', '20:00:00'),
(1, 'Wednesday', '18:00:00', '20:00:00'),

(2, 'Friday', '17:30:00', '19:30:00'),

(3, 'Tuesday', '18:00:00', '19:30:00'),
(3, 'Thursday', '18:00:00', '19:30:00'),

(4, 'Saturday', '17:00:00', '19:00:00'),

(5, 'Sunday', '19:00:00', '20:30:00');

INSERT INTO COURSE_INSTRUCTORS (COURSEID, UID) VALUES
(1, 6),  
(2, 2), 
(3, 2), 
(4, 6),
(5, 4);
