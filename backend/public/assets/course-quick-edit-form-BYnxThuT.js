import{z as ae,r as d,G as p,O as x,p as $,j as e,B as m,T as c,k as P,d as b,D as q,I as G,K as Y,A as re}from"./index-B-O2wvL4.js";import{u as z,a as B,o as O,C as Q,b as k,n as H,s as l,c as J}from"./zod-DxVdrIxN.js";import{t as T}from"./index-bP69XAuA.js";import{F as X,a as h}from"./form-provider-BL3TSD8n.js";import{A as Z,S as ee}from"./filters-result-CAwOcmvx.js";import{G as U}from"./Grid-Ba55pw_4.js";import{S as K}from"./Stack-BjYbPdpy.js";import{T as te}from"./TextField-BfDbW8wr.js";import{a as V,D as ne}from"./DialogTitle-w8z7uk1s.js";import{D as ie}from"./DialogActions-DZ5SCz5y.js";const oe=O({WEEKDAY:l().min(1,{message:"Weekday is required!"}),START_TIME:l().min(1,{message:"Start time is required!"}),END_TIME:l().min(1,{message:"End time is required!"})}).refine(t=>{const n=new Date(`2000-01-01T${t.START_TIME}`);return new Date(`2000-01-01T${t.END_TIME}`)>n},{message:"End time must be after start time",path:["END_TIME"]}),le=O({title:l().min(1,{message:"Course title is required!"}),location:l().min(1,{message:"Location is required!"}),startDate:l().min(1,{message:"Start date is required!"}),endDate:l().min(1,{message:"End date is required!"}),description:l().optional(),capacity:H().min(1,{message:"Capacity must be at least 1"}),instructors:k(J()).min(1,{message:"At least one instructor is required!"}),schedule:k(oe).min(1,{message:"At least one schedule entry is required!"})}).refine(t=>{const n=t.schedule.map(D=>D.WEEKDAY),u=[...new Set(n)];return n.length===u.length},{message:"Each day of the week can only appear once in the schedule",path:["schedule"]}).refine(t=>{const n=new Date(t.startDate);return new Date(t.endDate)>=n},{message:"End date must be after or equal to start date",path:["endDate"]});function ge({currentCourse:t}){const n=ae(),[u,D]=d.useState([]),[L,R]=d.useState(!1),[w,M]=d.useState(!0),E=d.useMemo(()=>({title:"",location:"",startDate:"",endDate:"",description:"",capacity:20,instructors:[],schedule:[{WEEKDAY:"Monday",START_TIME:"09:00",END_TIME:"10:00"}]}),[]),g=z({mode:"onChange",resolver:B(le),defaultValues:E}),{reset:f,handleSubmit:I,watch:S,setValue:N,formState:{isSubmitting:_,isDirty:A}}=g,C=S("schedule")||[],j=d.useCallback(a=>a?{title:a.TITLE||"",location:a.LOCATION||"",startDate:a.STARTDATE?a.STARTDATE.split("T")[0]:"",endDate:a.ENDDATE?a.ENDDATE.split("T")[0]:"",description:a.DESCRIPTION||"",capacity:a.CAPACITY||20,instructors:a.instructors||[],schedule:a.schedule||[{WEEKDAY:"Monday",START_TIME:"09:00",END_TIME:"10:00"}]}:E,[E]);d.useEffect(()=>{(async()=>{try{M(!0);const i=await p.get(x.roles.byName("Instructor"));if(D(i.data.users||[]),t!=null&&t.COURSEID)try{const[s,r]=await Promise.all([p.get(x.courses.instructors(t.COURSEID)),p.get(x.courses.schedule(t.COURSEID))]),o={...t,instructors:s.data.instructors||[],schedule:r.data.schedule||[]},y=j(o);f(y)}catch(s){console.error("Error fetching course details:",s);const r=j(t);f(r)}}catch(i){console.error("Error fetching instructors:",i),T.error("Failed to load instructors")}finally{M(!1)}})()},[t,j,f]);const v=a=>{N("schedule",a,{shouldValidate:!0,shouldDirty:!0})},W=a=>!a||a.length===0?"No schedule set":a.map(i=>`${i.WEEKDAY} ${i.START_TIME}-${i.END_TIME}`).join(", "),F=I(async a=>{try{const i={...a,instructors:a.instructors.map(s=>s.UID)};t?(await p.put(x.courses.details(t.COURSEID),i),T.success("Course updated successfully!")):(await p.post(x.courses.list,i),T.success("Course created successfully!")),f(),n.push($.dashboard.courses)}catch(i){console.error("Error saving course:",i),T.error(t?"Failed to update course!":"Failed to create course!")}});return w?e.jsx(m,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(c,{children:"Loading course data..."})}):e.jsxs(X,{methods:g,onSubmit:F,children:[e.jsxs(U,{container:!0,spacing:3,children:[e.jsx(U,{size:{xs:12,md:4},children:e.jsxs(P,{sx:{pt:10,pb:5,px:3},children:[e.jsxs(m,{sx:{mb:5},children:[e.jsx(c,{variant:"h6",sx:{mb:2},children:"Course Information"}),e.jsx(c,{variant:"body2",sx:{color:"text.secondary"},children:"Fill in the course details below. All required fields must be completed."})]}),t&&e.jsx(K,{sx:{mt:3,alignItems:"center",justifyContent:"center"},children:e.jsx(b,{variant:"soft",color:"error",onClick:async()=>{try{await p.delete(x.courses.details(t.COURSEID)),T.success("Course deleted successfully!"),n.push($.dashboard.courses)}catch(a){console.error("Error deleting course:",a),T.error("Failed to delete course!")}},children:"Delete course"})})]})}),e.jsx(U,{size:{xs:12,md:8},children:e.jsxs(P,{sx:{p:3},children:[e.jsxs(m,{sx:{rowGap:3,columnGap:2,display:"grid",gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)"}},children:[e.jsx(h.Text,{name:"title",label:"Course Title"}),e.jsx(h.Text,{name:"location",label:"Location"}),e.jsx(h.Text,{name:"startDate",label:"Start Date",type:"date",InputLabelProps:{shrink:!0}}),e.jsx(h.Text,{name:"endDate",label:"End Date",type:"date",InputLabelProps:{shrink:!0}}),e.jsx(h.Text,{name:"capacity",label:"Capacity",type:"number"}),e.jsx(h.Text,{name:"description",label:"Description",multiline:!0,rows:4,sx:{gridColumn:{xs:"span 1",sm:"span 2"}}})]}),e.jsx(q,{sx:{my:3}}),e.jsxs(m,{sx:{mb:3},children:[e.jsx(c,{variant:"h6",sx:{mb:2},children:"Instructors"}),e.jsx(c,{variant:"body2",sx:{color:"text.secondary",mb:2},children:"Select one or more instructors for this course"}),e.jsx(Q,{name:"instructors",control:g.control,render:({field:a,fieldState:{error:i}})=>e.jsx(Z,{...a,multiple:!0,options:u,getOptionLabel:s=>`${s.FIRSTNAME} ${s.LASTNAME}`,isOptionEqualToValue:(s,r)=>s.UID===r.UID,value:a.value||[],onChange:(s,r)=>{a.onChange(r),N("instructors",r,{shouldValidate:!0})},renderInput:s=>e.jsx(te,{...s,label:"Instructors",placeholder:"Select instructors...",error:!!i,helperText:i==null?void 0:i.message}),slotProps:{chip:{size:"small",variant:"soft"}}})})]}),e.jsx(q,{sx:{my:3}}),e.jsxs(m,{sx:{mb:3},children:[e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(c,{variant:"h6",children:"Schedule"}),e.jsx(b,{variant:"outlined",startIcon:e.jsx(G,{icon:"eva:edit-fill"}),onClick:()=>R(!0),children:C.length>0?"Edit Schedule":"Set Schedule"})]}),e.jsx(c,{variant:"body2",sx:{color:"text.secondary",mb:2},children:"Set the schedule for each day independently"}),e.jsx(P,{sx:{p:2,bgcolor:"background.neutral"},children:e.jsx(c,{variant:"body2",sx:{color:"text.secondary"},children:W(C)})})]}),e.jsx(K,{sx:{mt:3,alignItems:"flex-end"},children:e.jsx(b,{type:"submit",variant:"contained",loading:_,disabled:t&&!A,children:t?A?"Save changes":"No changes made":"Create course"})})]})})]}),e.jsx(ee,{open:L,onClose:()=>R(!1),onSave:v,initialSchedule:C})]})}const ce=O({WEEKDAY:l().min(1,{message:"Weekday is required!"}),START_TIME:l().min(1,{message:"Start time is required!"}),END_TIME:l().min(1,{message:"End time is required!"})}).refine(t=>{const n=new Date(`2000-01-01T${t.START_TIME}`);return new Date(`2000-01-01T${t.END_TIME}`)>n},{message:"End time must be after start time",path:["END_TIME"]}),de=O({title:l().min(1,{message:"Course title is required!"}),location:l().min(1,{message:"Location is required!"}),startDate:l().min(1,{message:"Start date is required!"}),endDate:l().min(1,{message:"End date is required!"}),description:l().optional(),capacity:H().min(1,{message:"Capacity must be at least 1"}),instructors:k(J()).min(1,{message:"At least one instructor is required!"}),schedule:k(ce).min(1,{message:"At least one schedule entry is required!"})}).refine(t=>{const n=t.schedule.map(D=>D.WEEKDAY),u=[...new Set(n)];return n.length===u.length},{message:"Each day of the week can only appear once in the schedule",path:["schedule"]}).refine(t=>{const n=new Date(t.startDate);return new Date(t.endDate)>=n},{message:"End date must be after or equal to start date",path:["endDate"]});function Se({currentCourse:t,open:n,onClose:u}){const[D,L]=d.useState([]),[R,w]=d.useState(!1),[M,E]=d.useState(!1),g=d.useMemo(()=>({title:"",location:"",startDate:"",endDate:"",description:"",capacity:20,instructors:[],schedule:[{WEEKDAY:"Monday",START_TIME:"09:00",END_TIME:"10:00"}]}),[]),f=d.useCallback(s=>s?{title:s.TITLE||"",location:s.LOCATION||"",startDate:s.STARTDATE?s.STARTDATE.split("T")[0]:"",endDate:s.ENDDATE?s.ENDDATE.split("T")[0]:"",description:s.DESCRIPTION||"",capacity:s.CAPACITY||20,instructors:s.instructors||[],schedule:s.schedule||[{WEEKDAY:"Monday",START_TIME:"09:00",END_TIME:"10:00"}]}:g,[g]),I=z({mode:"onSubmit",resolver:B(de),defaultValues:g}),{reset:S,handleSubmit:N,watch:_,setValue:A,formState:{isSubmitting:C,isDirty:j}}=I,v=_("schedule")||[];d.useEffect(()=>{n||E(!1)},[n]),d.useEffect(()=>{const s=async()=>{try{const r=await p.get(x.roles.byName("Instructor"));L(r.data.users||[])}catch(r){console.error("Error fetching instructors:",r),T.error("Failed to load instructors")}};n&&D.length===0&&s()},[n,D.length]),d.useEffect(()=>{n&&(t!=null&&t.COURSEID)?(async()=>{E(!0);try{const[r,o]=await Promise.all([p.get(x.courses.instructors(t.COURSEID)),p.get(x.courses.schedule(t.COURSEID))]),y={...t,instructors:r.data.instructors||[],schedule:o.data.schedule||[]},se=f(y);S(se)}catch(r){console.error("Error fetching course details:",r);const o=f(t);S(o)}finally{E(!1)}})():n&&E(!1)},[n,t,f,S]);const W=s=>{A("schedule",s,{shouldValidate:!0,shouldDirty:!0})},F=s=>!s||s.length===0?"No schedule set":s.map(r=>`${r.WEEKDAY} ${r.START_TIME}-${r.END_TIME}`).join(", "),a=N(async s=>{try{const r={...s,instructors:s.instructors.map(o=>o.UID||o.uid||o.id).filter(Boolean)};await p.put(x.courses.details(t.COURSEID),r),T.success("Course updated successfully!"),u(),S(),window.location.reload()}catch(r){console.error("Error updating course:",r),T.error("Failed to update course!")}}),i=()=>{S(),E(!1),u()};return M?e.jsx(Y,{fullWidth:!0,maxWidth:"md",open:n,onClose:i,PaperProps:{sx:{borderRadius:2}},children:e.jsx(V,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(c,{children:"Loading course data..."})})}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{fullWidth:!0,maxWidth:"md",open:n,onClose:i,PaperProps:{sx:{borderRadius:2}},children:e.jsxs(X,{methods:I,onSubmit:a,children:[e.jsx(ne,{children:e.jsx(m,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:e.jsx(c,{variant:"h6",children:"Edit Course"})})}),e.jsxs(V,{dividers:!0,sx:{pt:3},children:[e.jsx(re,{severity:"info",sx:{mb:3},children:"Update the course information below. All required fields must be completed."}),e.jsxs(m,{sx:{rowGap:3,columnGap:2,display:"grid",gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)"}},children:[e.jsx(h.Text,{name:"title",label:"Course Title"}),e.jsx(h.Text,{name:"location",label:"Location"}),e.jsx(h.Text,{name:"startDate",label:"Start Date",type:"date",InputLabelProps:{shrink:!0}}),e.jsx(h.Text,{name:"endDate",label:"End Date",type:"date",InputLabelProps:{shrink:!0}}),e.jsx(h.Text,{name:"capacity",label:"Capacity",type:"number"}),e.jsx(h.Text,{name:"description",label:"Description",multiline:!0,rows:4,sx:{gridColumn:{xs:"span 1",sm:"span 2"}}})]}),e.jsx(q,{sx:{my:3}}),e.jsxs(m,{sx:{mb:3},children:[e.jsx(c,{variant:"h6",sx:{mb:2},children:"Instructors"}),e.jsx(c,{variant:"body2",sx:{color:"text.secondary",mb:2},children:"Select one or more instructors for this course"}),e.jsx(Q,{name:"instructors",control:I.control,render:({field:s,fieldState:{error:r}})=>e.jsx(Z,{...s,multiple:!0,options:D,getOptionLabel:o=>`${o.FIRSTNAME} ${o.LASTNAME}`,isOptionEqualToValue:(o,y)=>o.UID===y.UID,value:s.value||[],onChange:(o,y)=>{s.onChange(y),A("instructors",y,{shouldValidate:!0})},renderInput:o=>e.jsx(te,{...o,label:"Instructors",placeholder:"Select instructors...",error:!!r,helperText:r==null?void 0:r.message}),slotProps:{chip:{size:"small",variant:"soft"}}})})]}),e.jsx(q,{sx:{my:3}}),e.jsxs(m,{sx:{mb:3},children:[e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(c,{variant:"h6",children:"Schedule"}),e.jsx(b,{variant:"outlined",startIcon:e.jsx(G,{icon:"eva:edit-fill"}),onClick:()=>w(!0),children:v.length>0?"Edit Schedule":"Set Schedule"})]}),e.jsx(c,{variant:"body2",sx:{color:"text.secondary",mb:2},children:"Set the schedule for each day independently"}),e.jsx(m,{sx:{p:2,bgcolor:"background.neutral",borderRadius:1},children:e.jsx(c,{variant:"body2",sx:{color:"text.secondary"},children:F(v)})})]})]}),e.jsxs(ie,{sx:{px:3,pb:3},children:[e.jsx(b,{variant:"outlined",color:"inherit",onClick:i,children:"Cancel"}),e.jsx(b,{type:"submit",variant:"contained",loading:C,disabled:!j,children:j?"Save changes":"No changes made"})]})]})}),e.jsx(ee,{open:R,onClose:()=>w(!1),onSave:W,initialSchedule:v})]})}export{Se as C,ge as a};
